name: Deploy to Hetzner

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"

            cd /var/www/n8than.dev
            git pull origin main
            bun install --frozen-lockfile
            bun run build

            cp deploy/Caddyfile /etc/caddy/sites/n8than.dev
            caddy validate --config /etc/caddy/Caddyfile
            systemctl reload caddy
